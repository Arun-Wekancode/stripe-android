#!/usr/bin/env ruby

require_relative '../../lib/yoyo'
require 'excon'

class AddUser
  def ldapmanager_conn
    @conn ||= Excon.new("http://ldapmanager.corp.stripe.com",
                        proxy: {scheme: 'unix', path: "#{ENV['HOME']}/.stripeproxy"},
                        persistent: true)
  end

  def add_user(user, fullname, ssh_key)
    if ldapmanager_conn.get(path: "/api/v1/users/#{user}").status == 400
      create_request = {
        username: user,
        name: fullname,

        pubkeys: [ssh_key],
        privileges: [],
        pubkeys: [],
      }
      ldapmanager_conn.post(path: '/api/v1/users', body: JSON.dump(create_request))
    else
      body={public_key: ssh_key}
      ldapmanager_conn.post(path: "/api/v1/users/#{user}", body: JSON.dump(body))
    end
  end

  def run
    if ARGV.count > 2 || ARGV.count < 2
      usage
    end
    puts "Paste the SSH Key (without '---- BEGIN') now, then press Enter:"
    ssh_key = $stdin.readline
    unless ssh_key.start_with?('ssh-rsa')
      raise "That wasn't a proper SSH key, I think?"
    end
    add_user(ARGV[0], ARGV[1], ssh_key)
  end

  def usage
    raise <<-EOM
USAGE: create_linux_ldap_user shortname "Full Name"
EOM
  end
end

AddUser.new.run() if File.basename(__FILE__) == File.basename($0)
