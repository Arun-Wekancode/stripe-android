#!/usr/bin/env ruby

require_relative '../../lib/yoyo'
require 'excon'

class AddUser
  def ldapmanager_conns(&blk)
    ["http://ldapmanager.corp.stripe.com", "http://ldapmanager.qa.corp.stripe.com"].each do |url|
      blk.call (Excon.new("http://ldapmanager.corp.stripe.com",
                          proxy: {scheme: 'unix', path: "#{ENV['HOME']}/.stripeproxy"},
                          persistent: true))
    end
  end

  def add_user(user, fullname, ssh_key)
    ldapmanager_conns do |conn|
      if conn.get(path: "/api/v1/users/#{user}").status == 400
        create_request = {
          username: user,
          name: fullname,

          pubkeys: [ssh_key],
          groups: ['stripe'],
          pubkeys: [],
        }
        conn.post(path: '/api/v1/users', body: JSON.dump(create_request))
      end
      body={public_key: ssh_key}
      conn.post(path: "/api/v1/users/#{user}", body: JSON.dump(body))
    end
  end

  def run
    if ARGV.count > 2 || ARGV.count < 2
      usage
    end
    puts "Paste the SSH Key (without '---- BEGIN') now, then press Enter:"
    ssh_key = $stdin.readline
    unless ssh_key.start_with?('ssh-rsa')
      raise "That wasn't a proper SSH key, I think?"
    end
    add_user(ARGV[0], ARGV[1], ssh_key)
  end

  def usage
    raise <<-EOM
USAGE: create_linux_ldap_user shortname "Full Name"
EOM
  end
end

AddUser.new.run() if File.basename(__FILE__) == File.basename($0)
