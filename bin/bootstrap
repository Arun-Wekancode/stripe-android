#!/bin/bash
set -eu

run() {
    echo >&2 "+ $*"
    "$@"
}

# we shouldn't be root when running this
if [ "$(id -u)" -eq 0 ]; then
    echo "error: this script should not be run as root"
    exit 1
fi

# install software updates (specifically so we get OS X 10.9.2+), but
# only once:
if ! sudo softwareupdate --schedule | grep '^Automatic check is off'; then
    run sudo softwareupdate --install --all
    run sudo softwareupdate --schedule on
fi

# turn on filevault if it's not on
if ! run fdesetup isactive; then
    echo "Full disk encryption is not active"
    read -p "Press enter to immediately restart to enable..." ans
    run sudo fdesetup enable -user $USER -forcerestart
fi

trap 'echo ERROR' EXIT

# enable SSH
run sudo systemsetup -setremotelogin on

# SSH key doesn't exist until we hit the SSH server for the first time
echo hello | run nc -z localhost 22

if ! which sixword >/dev/null; then
    run sudo gem install sixword
fi

suggested_ip=''
echo "Potential IP addresses:"
for i in $(seq 0 "$(ipconfig ifcount)"); do
    if="en$i"
    ip="$(ipconfig getifaddr "$if" || true)"
    if ! [ -z "$ip" ] ; then
        echo "$if: $ip"
        if [ -z "$suggested_ip" ] ; then
            suggested_ip="$ip"
        else
            suggested_ip="{IP}"
        fi
    fi
done

echo "SSH key fingerprint:"
ssh-keygen -lf /etc/ssh_host_rsa_key.pub | cut -d' ' -f2 | sixword -H

echo "Please run \`yoyo spinup $suggested_ip $USER\` on the credentialer machine..."
echo "(Waiting for you to run that command...)"
while ! [ -f ~/.ssh/authorized_keys ] ; do
    sleep 1
done

run sudo mkdir -vp ~root/.ssh
run sudo cp -v ~/.ssh/authorized_keys ~root/.ssh/

trap - EXIT

echo "Yoyo is now set up and running!"
