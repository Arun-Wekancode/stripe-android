#!/usr/bin/env ruby

require_relative '../lib/yoyo'
require 'chalk-cli'

class Spinup < Chalk::CLI::Command
  def invoke
    if arguments.length != 3
      usage
      return false
    end
    command_name, ip_address, username = arguments

    mgr = Yoyo::Manager.new(ip_address, username, :no_certs => options[:no_certs])
    mgr.deploy_authorized_keys! unless mgr.keys_deployed?
    mgr.spin_up!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} spinup [OPTIONS] IP USERNAME')
  App.options do |opts|
    opts.opt :no_certs, "Skip the certificate-generation step (for spinning up a second/replacement machine for an existing stripe)",
             :short => 'n', :default => false
  end
  App.action(self)
end

class Cleanup < Chalk::CLI::Command
  def invoke
    command_name, ip_address, username = arguments
    mgr = Yoyo::Manager.new(ip_address, username)
    mgr.disable_ssh!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} cleanup IP USERNAME')
  App.action(self)
end

def usage
  $stderr.puts <<-EOM
usage: #{File.basename($0)} COMMAND [ARGS...]

Commands:

    spinup [options] IP_ADDRESS USERNAME

    cleanup IP_ADDRESS USERNAME

    EOM
  return 1
end

def parse_args(args)
  case args.first
  when 'spinup'
    Spinup::App.run_if_invoked(__FILE__)
  when 'cleanup'
    Cleanup::App.run_if_invoked(__FILE__)
  else
    return usage
  end

  return 0
end

exit(parse_args(ARGV))
