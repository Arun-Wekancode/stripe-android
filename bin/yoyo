#!/usr/bin/env ruby

require_relative '../lib/yoyo'
require 'chalk-cli'
require 'sentry-raven'

class Spinup < Yoyo::Command
  NECESSARY_GROUPS=%w{stripe}

  def do_invoke
    if arguments.length != 3
      usage
      return false
    end
    command_name, ip_address, username = arguments
    groups = NECESSARY_GROUPS + options[:groups].split(/,\s*/)

    args = {
      :no_certs => options[:no_certs],
      :groups => groups,
      :gpg_key => options[:gpg_key],
      :stripe_user => options[:stripe_user],
      :machine_number => options[:machine].to_s,
      :puppet_endpoint => options[:puppet_endpoint],
      :puppet_server => options[:puppet_server],
    }

    mgr = Yoyo::Manager.new(ip_address, username, args)
    mgr.deploy_authorized_keys! unless mgr.keys_deployed?
    mgr.spin_up!
    mgr.disable_ssh!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} spinup [OPTIONS] IP USERNAME')
  App.options do |opts|
    opts.opt :no_certs, "Skip the certificate-generation step (for spinning up contractor machines)",
             :default => false
    opts.opt :groups, "Add the user to these permission groups in puppet (separated by commas)",
             :type => :string, :default => "devbox"
    opts.opt :gpg_key, "Assume this GPG fingerprint is the existing key",
             :type => :string, :default => nil
    opts.opt :stripe_user, 'Stripe username, if different from local username',
             :type => :string, :default => nil
    opts.opt :machine, 'Stripe machine number (this goes on "st-userNN")',
             :type => :integer, :default => nil
    opts.opt :puppet_endpoint, 'Puppet service address to use',
             :type => :string, :default => 'marionette.corp.stripe.com'
    opts.opt :puppet_server, 'Puppet server to use for puppet CA actions',
             :type => :string, :default => 'marionette1.northwest.stripe.io'
  end
  App.action(self)
end

class Cleanup < Yoyo::Command
  def do_invoke
    command_name, ip_address, username = arguments
    mgr = Yoyo::Manager.new(ip_address, username)
    mgr.disable_ssh!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} cleanup IP USERNAME')
  App.action(self)
end

class Decredential < Yoyo::Command
  def do_invoke
    command_name, username = arguments
    mgr = Yoyo::Manager.new(nil, username)
    mgr.decredential_user!
  end

  App = Chalk::CLI::App.new("Usage: #{$0} decredential USERNAME")
  App.action(self)
end

class GPGSign < Yoyo::Command
  def do_invoke
    command_name, keyid = arguments
    args = {
      gpg_key: keyid,
      gpg_signing_identities: options[:identities].flatten,
    }
    mgr = Yoyo::Manager.new(nil, nil, args)
    mgr.sign_gpg_key!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} gpg-sign [OPTIONS] -- KEYID')
  App.options do |opts|
    opts.opt :identities, "Identities to sign the key ID with",
             :type => :strings, :multi => true, :default => ['ca']
  end
  App.action(self)
end

class GPGRevoke < Yoyo::Command
  def do_invoke
    command_name, keyid = arguments
    args = {
      gpg_key: keyid,
      gpg_signing_identities: options[:identities].flatten,
    }
    mgr = Yoyo::Manager.new(nil, nil, args)
    mgr.revoke_gpg_key!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} gpg-revoke [OPTIONS] -- KEYID')
  App.options do |opts|
    opts.opt :identities, "Identities to revoke signatures on the key ID with",
             :type => :strings, :multi => true, :default => ['ca', 'deploy']
  end
  App.action(self)
end

class AddVendor < Yoyo::Command
  def do_invoke
    args = {
      username: arguments[0],
      full_name: arguments[1],
    }
    mgr = Yoyo::Manager.new(nil, nil, args)
    mgr.add_vendor!
  end

  App = Chalk::CLI::App.new('Usage: #{$0} add-vendor username "Full Name"')
  App.options do |opts|
    # No options yet!
  end
  App.action(self)
end

def usage
  $stderr.puts <<-EOM
usage: #{File.basename($0)} COMMAND [ARGS...]

Commands:

    spinup [options] IP_ADDRESS USERNAME

    cleanup IP_ADDRESS USERNAME

    decredential USERNAME

    gpg-sign KEYID

    add-vendor USERNAME "FULL NAME"

    EOM
  return 1
end

def parse_args(args)
  case args.first
  when 'spinup'
    Spinup::App.run_if_invoked(__FILE__)
  when 'cleanup'
    Cleanup::App.run_if_invoked(__FILE__)
  when 'decredential'
    Decredential::App.run_if_invoked(__FILE__)
  when 'gpg-sign'
    GPGSign::App.run_if_invoked(__FILE__)
  when 'gpg-revoke'
    GPGRevoke::App.run_if_invoked(__FILE__)
  when 'add-vendor'
    AddVendor::App.run_if_invoked(__FILE__)
  else
    return usage
  end

  return 0
end

exit(parse_args(ARGV))
